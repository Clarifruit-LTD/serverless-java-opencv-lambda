<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Webcam Video Feed</title>
</head>

<body>
    <h1>Webcam Live Feed</h1>
    <video id="webcam" autoplay playsinline></video>
    <h1>Processed Image</h1>
    <img id="processed" src="">
    <br />
    <input type="checkbox" id="pause" name="Pause" value="Pause" checked />
    <label for="pause">Pause</label>
    <!-- dropdown for mode query string parameter with options Grayscale, GreenBlueRedSplit -->
    <select id="mode" name="mode">
        <option value="Grayscale">Grayscale</option>
        <option value="GreenBlueRedSplit">Green-Blue-Red Split</option>
        <option value="FaceDetection">Face Detection</option>
        <option value="Mandarin">Mandarin Detection</option>
    </select>


    <script>
        // Access webcam
        async function setupWebcam() {
            const video = document.getElementById('webcam');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { max: 300 }, height: { max: 300 } } });
                video.srcObject = stream;
                video.play();
                return true;
            } catch (error) {
                console.error('Error accessing webcam:', error);
                return false;
            }
        }
        
        async function fetchWithRetry(url, options, maxRetries = 20, backoffFactor = 0.3) {
            let retries = 0;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status < 500) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    if (retries === maxRetries - 1) {
                        throw error;
                    }
                    const backoffTime = Math.pow(2, retries) * backoffFactor;
                    console.warn(`Retrying in ${backoffTime}s due to error: ${error.message}`);
                    await new Promise(resolve => setTimeout(resolve, backoffTime * 1000));
                }
                retries++;
            }

            throw new Error(`Max retries (${maxRetries}) exceeded`);
        }

        // Send frame to a web service and update the processed image
        function processFrame() {
            let result = new Promise((resolve, reject) => {
                const video = document.getElementById('webcam');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                // console.log(`Canvas size: ${canvas.width} x ${canvas.height}`)
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Convert canvas to blob and send to a web service
                canvas.toBlob(async (blob) => {
                    // Replace 'yourWebServiceURL' with the URL of your web service
                    try {
                        //get the mode value
                        const mode = document.getElementById('mode').value;
                        // console.log(`Mode: ${mode}`);
                        const response = await fetchWithRetry(`/?mode=${mode}`, {
                            method: 'POST',
                            body: blob
                        });


                        const imageBlob = await response.blob();
                        const imageUrl = URL.createObjectURL(imageBlob);
                        document.getElementById('processed').src = imageUrl;
                        resolve();
                    } catch (error) {
                        console.error('Error processing image:', error);
                        reject(error);
                    }
                });

            });
            return result;
        }

        async function startProcessingLoop() {
            const pauseCheckbox = document.getElementById('pause');
            const isWebcamSetup = await setupWebcam();
            if (isWebcamSetup) {
                while (true) {
                    if (pauseCheckbox.checked) {
                        await new Promise((resolve) => {
                            pauseCheckbox.onchange = resolve;
                        });
                    } else {
                        await processFrame();
                    }
                }
            }
        }

        startProcessingLoop();
    </script>

</body>

</html>
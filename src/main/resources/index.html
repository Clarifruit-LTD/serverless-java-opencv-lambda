<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Webcam Video Feed</title>
</head>

<body>

    <h1>Webcam Live Feed</h1>
    <video id="webcam" autoplay></video>
    <h1>Processed Image</h1>
    <img id="processed" src="">
    <br />
    <input type="checkbox" id="pause" name="Pause" value="Pause" checked />
    <label for="pause">Pause</label>

    <script>
        // Access webcam
        async function setupWebcam() {
            const video = document.getElementById('webcam');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { max: 300 }, height: { max: 300 } } });
                video.srcObject = stream;
                return true;
            } catch (error) {
                console.error('Error accessing webcam:', error);
                return false;
            }
        }

        // Send frame to a web service and update the processed image
        function processFrame() {
            let result = new Promise((resolve, reject) => {
                const video = document.getElementById('webcam');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                console.log(`Canvas size: ${canvas.width} x ${canvas.height}`)
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Convert canvas to blob and send to a web service
                canvas.toBlob(async (blob) => {
                    // Replace 'yourWebServiceURL' with the URL of your web service
                    try {
                        const response = await fetch('https://47gjxgowcrvusxmfqkprkzfr7q0ospym.lambda-url.ap-southeast-2.on.aws/', {
                            method: 'POST',
                            body: blob
                        });
                        const imageBlob = await response.blob();
                        const imageUrl = URL.createObjectURL(imageBlob);
                        document.getElementById('processed').src = imageUrl;
                        resolve();
                    } catch (error) {
                        console.error('Error processing image:', error);
                        reject(error);
                    }
                });

            });
            return result;
        }

        async function startProcessingLoop() {
            const pauseCheckbox = document.getElementById('pause');
            const isWebcamSetup = await setupWebcam();
            if (isWebcamSetup) {
                while (true) {
                    if (pauseCheckbox.checked) {
                        await new Promise((resolve) => {
                            const onChange = () => {
                                pauseCheckbox.removeEventListener('change', onChange);
                                resolve();
                            };
                            pauseCheckbox.addEventListener('change', onChange);
                        });
                    } else {
                        await processFrame();
                    }
                }
            }
        }

        startProcessingLoop();
    </script>

</body>

</html>